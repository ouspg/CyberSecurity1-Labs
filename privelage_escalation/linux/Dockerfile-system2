# --- Stage 1: Build the vulnerable binary ---
FROM gcc:11 AS builder

WORKDIR /src
COPY ./scripts/vulnerable.c ./
RUN gcc vulnerable.c -o tns_runner -w

# --- Stage 2: Main image setup ---
FROM ubuntu:focal

# Install required packages
RUN apt-get update && apt-get install -y \
    vim \
    nano \
    openssh-server \
    sudo \
    cron \
    less \
    python3 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Create realistic directories
RUN mkdir -p \
    /opt/scripts \
    /var/backups \
    /srv/jenkins \
    /opt/legacy_tools \
    /mnt/shared/reports \
    /home/shared_configs

# Add dummy scripts
RUN echo -e "#!/bin/bash\n# nightly security scan" > /opt/scripts/security_scan.sh && \
    echo -e "#!/bin/bash\necho 'rotating logs...'" > /opt/scripts/log_rotate.sh && \
    chmod 740 /opt/scripts/security_scan.sh /opt/scripts/log_rotate.sh

# SSH setup
RUN mkdir /var/run/sshd

# --- User and group setup ---
RUN groupadd -g 1004 usergroup1 && \
    groupadd -g 1005 usergroup2

RUN useradd -m -s /bin/bash devops_venla && \
    echo "devops_venla:princess1" | chpasswd && \
    usermod -aG usergroup1 devops_venla && \
    chmod 771 /home/devops_venla

RUN useradd -m -s /bin/bash jenkins_agent && \
    echo "jenkins_agent:superstr0n3P7ssW04d" | chpasswd && \
    usermod -aG usergroup1 jenkins_agent && \
    usermod -aG usergroup2 jenkins_agent && \
    chmod 771 /home/jenkins_agent

RUN useradd -m -s /bin/bash admin_anna && \
    echo "admin_anna:superstr0n3P7ssW04d" | chpasswd && \
    usermod -aG usergroup2 admin_anna && \
    chmod 771 /home/admin_anna

# --- Level 2: PATH privilege escalation setup ---
COPY --from=builder /src/tns_runner /home/jenkins_agent/tns_runner
RUN chown root:usergroup1 /home/jenkins_agent/tns_runner && \
    chmod 4750 /home/jenkins_agent/tns_runner
RUN ln -s /home/jenkins_agent/tns_runner /home/devops_venla/tns_runner

# --- Level 3: Cron job setup ---
COPY ./scripts/cron.sh /home/jenkins_agent/build.sh
RUN chown admin_anna:usergroup2 /home/jenkins_agent/build.sh && \
    chmod 760 /home/jenkins_agent/build.sh

RUN echo "Pipeline build failed." > /home/jenkins_agent/build_log.txt && \
    chown jenkins_agent:usergroup2 /home/jenkins_agent/build_log.txt && \
    chmod 640 /home/jenkins_agent/build_log.txt

COPY ./configs/crontab /etc/crontab
RUN chmod 644 /etc/crontab

# --- Level 4: SUDO setup ---
COPY ./configs/sudoers /etc/sudoers
RUN chmod 440 /etc/sudoers

# --- Entrypoint ---
COPY ./scripts/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod 770 /usr/local/bin/entrypoint.sh

CMD ["/usr/local/bin/entrypoint.sh"]